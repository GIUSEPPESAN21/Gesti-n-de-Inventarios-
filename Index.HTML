<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Inventario Pro X</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“¦</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script> <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; /* Tailwind slate-100 */
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; } /* Tailwind slate-200 */
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 10px; } /* Tailwind slate-500 */
        ::-webkit-scrollbar-thumb:hover { background: #475569; } /* Tailwind slate-600 */
        
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* Tailwind shadow-md */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* Tailwind shadow-lg */
        }
        .btn {
            border-radius: 0.5rem; font-weight: 600; padding-top: 0.625rem; padding-bottom: 0.625rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* Tailwind shadow-sm */
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn .spinner {
            width: 1em; height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
            margin-right: 0.5em; display: none; /* Hidden by default */
        }
        .btn.loading .spinner { display: inline-block; }
        .btn.loading .btn-text { margin-left: 0.25em; }


        .btn-primary { background-color: #3b82f6; color: white; } /* blue-500 */
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; } /* blue-600 */
        .btn-secondary { background-color: #64748b; color: white; } /* slate-500 */
        .btn-secondary:hover:not(:disabled) { background-color: #475569; } /* slate-600 */
        .btn-success { background-color: #10b981; color: white; } /* green-500 */
        .btn-success:hover:not(:disabled) { background-color: #059669; } /* green-600 */
        .btn-danger { background-color: #ef4444; color: white; } /* red-500 */
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; } /* red-600 */
        .btn-warning { background-color: #f59e0b; color: white; } /* amber-500 */
        .btn-warning:hover:not(:disabled) { background-color: #d97706; } /* amber-600 */
        .btn-info { background-color: #6366f1; color: white; } /* indigo-500 */
        .btn-info:hover:not(:disabled) { background-color: #4f46e5; } /* indigo-600 */
        
        .input-field, .search-field {
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.5rem; padding: 0.625rem 0.75rem;
            font-size: 0.875rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: white;
        }
        .input-field:focus, .search-field:focus { 
            outline: none; border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); 
        }
        .search-field { padding-left: 2.5rem; } /* Space for icon */

        .section-title {
            font-size: 1.25rem; font-weight: 600; color: #1e293b; /* slate-800 */
            padding-bottom: 0.75rem; border-bottom: 2px solid #e2e8f0; /* slate-200 */
            margin-bottom: 1rem;
        }
        
        /* Notification System Styles */
        #notification-container {
            position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1050;
            width: 350px; display: flex; flex-direction: column; gap: 0.75rem;
        }
        .notification {
            padding: 1rem 1.25rem; border-radius: 0.5rem; color: white;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            opacity: 0; transform: translateX(100%);
            animation: slideInNotification 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards, 
                       fadeOutNotification 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) 4.6s forwards;
            display: flex; align-items: center;
        }
        .notification i { margin-right: 0.75rem; font-size: 1.375rem; }
        .notification.success { background-color: #22c55e; } /* green-500 (Tailwind v3) */
        .notification.error { background-color: #ef4444; }   /* red-500 */
        .notification.warning { background-color: #f97316; } /* orange-500 */
        .notification.info { background-color: #3b82f6; }    /* blue-500 */

        @keyframes slideInNotification { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOutNotification { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

        /* Custom Modal Styles */
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.75); /* slate-900 with opacity */
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1040;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: 90%; max-width: 500px;
            transform: scale(0.95); transition: transform 0.3s ease;
            overflow: hidden;
        }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .modal-body { padding: 1.5rem; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background-color: #f8fafc; } /* slate-50 */

        /* Low stock visual cue */
        .low-stock-indicator {
            background-color: #fef2f2; /* red-50 */
            color: #dc2626; /* red-600 */
            border-left: 4px solid #ef4444; /* red-500 */
        }
        .low-stock-text::after {
            content: " (Bajo Stock!)";
            font-weight: bold;
            color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <div id="notification-container"></div>

    <div id="confirmationModal" class="modal-backdrop">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmationModalTitle">
            <div class="modal-header">
                <h3 id="confirmationModalTitle" class="text-xl font-semibold text-slate-800">Confirmar AcciÃ³n</h3>
            </div>
            <div class="modal-body">
                <p id="confirmationModalMessage" class="text-slate-600">Â¿EstÃ¡s seguro de que deseas realizar esta acciÃ³n?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmCancelBtn" class="btn btn-secondary px-4">Cancelar</button>
                <button id="confirmActionBtn" class="btn btn-danger px-4">Confirmar</button>
            </div>
        </div>
    </div>

    <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-slate-700 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 mr-3 text-blue-500">
                <path d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a.375.375 0 0 1-.375-.375V6.375c0-1.036-.84-1.875-1.875-1.875H5.625Zm4.5 0V9a.75.75 0 0 0 .75.75h2.25A.75.75 0 0 0 14.25 9V1.5H10.125Z" />
                <path d="M12.998 1.5c.007.002.014.004.022.006h-.022Zm-.022 0c-.007.002-.014.004-.022.006h.022ZM12.751 6a.75.75 0 0 0-.75-.75H4.5a.75.75 0 0 0-.75.75v13.5a.75.75 0 0 0 .75.75h15a.75.75 0 0 0 .75-.75V12a.75.75 0 0 0-.75-.75h-3.625a.75.75 0 0 1-.75-.75V6h-2.625Z" />
            </svg>
            Gestor de Inventario Pro X
        </h1>
    </header>

    <div class="container mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">

        <div class="card p-6 flex flex-col">
            <div class="flex justify-between items-center section-title">
                <h2 class="flex items-center"><i class="fas fa-boxes-stacked text-blue-500 mr-3 fa-fw"></i>Inventario</h2>
                <button onclick="downloadInventoryPDF(event)" class="btn btn-primary text-xs py-1 px-3"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
            </div>
            <div class="relative mb-4">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-slate-400"></i>
                </div>
                <input type="text" id="inventory-search" onkeyup="filterInventory()" placeholder="Buscar en inventario..." class="search-field w-full text-sm">
            </div>
            <div id="inventory-list" class="mb-4 max-h-72 min-h-[5rem] overflow-y-auto flex-grow pr-2">
                <p class="text-slate-500 text-sm italic p-4 text-center">Cargando inventario...</p>
            </div>
            <div class="mt-auto pt-4 border-t border-slate-200">
                <h3 class="font-semibold mb-3 text-lg text-slate-700">Agregar/Actualizar Item</h3>
                <input type="text" id="ingredient-name" placeholder="Nombre del ingrediente" class="input-field mb-2 w-full text-sm">
                <input type="number" id="ingredient-qty" placeholder="Cantidad a agregar" class="input-field mb-2 w-full text-sm" min="1">
                <p id="add-inventory-error" class="text-red-600 text-sm mt-1 mb-2 hidden"></p>
                <button id="addInventoryBtn" onclick="addInventoryItem()" class="btn btn-primary w-full text-sm">
                    <span class="spinner"></span><span class="btn-text"><i class="fas fa-plus mr-2"></i> Agregar al Inventario</span>
                </button>
            </div>
        </div>

        <div class="card p-6 flex flex-col">
            <h2 class="section-title flex justify-between items-center">
                GestiÃ³n de Pedidos <i class="fas fa-receipt text-green-500 ml-2"></i>
            </h2>
            <div class="mb-6">
                 <button onclick="openAddOrderModal()" class="btn btn-success w-full text-sm"><i class="fas fa-plus mr-2"></i> Agregar Nuevo Pedido</button>
            </div>

            <div class="mb-6 flex-grow flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold text-lg text-slate-700">Pedidos en Proceso</h3>
                    <button onclick="downloadOrdersPDF('processing', event)" class="btn btn-warning text-xs py-1 px-2"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
                </div>
                <div class="relative mb-2">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-slate-400"></i></div>
                    <input type="text" id="processing-orders-search" onkeyup="filterProcessingOrders()" placeholder="Buscar pedidos en proceso..." class="search-field w-full text-sm">
                </div>
                <div id="processing-orders" class="max-h-56 min-h-[5rem] overflow-y-auto bg-slate-50 p-3 rounded-md border border-slate-200 pr-1 flex-grow">
                    <p class="text-slate-500 text-sm italic p-3 text-center">Cargando pedidos en proceso...</p>
                </div>
            </div>

            <div class="flex-grow flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold text-lg text-slate-700">HistÃ³rico de Pedidos</h3>
                     <button onclick="downloadOrdersPDF('completed', event)" class="btn btn-secondary text-xs py-1 px-2"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
                </div>
                 <div class="relative mb-2">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-slate-400"></i></div>
                    <input type="text" id="completed-orders-search" onkeyup="filterCompletedOrders()" placeholder="Buscar en historial..." class="search-field w-full text-sm">
                </div>
                <div id="completed-orders" class="max-h-56 min-h-[5rem] overflow-y-auto bg-slate-50 p-3 rounded-md border border-slate-200 pr-1 flex-grow">
                    <p class="text-slate-500 text-sm italic p-3 text-center">Cargando historial de pedidos...</p>
                </div>
            </div>
        </div>

        <div class="card p-6 flex flex-col">
            <div class="flex justify-between items-center section-title">
                <h2 class="flex items-center"><i class="fas fa-chart-pie text-indigo-500 mr-3 fa-fw"></i>Informe Financiero</h2>
                <button onclick="downloadReportPDF(event)" class="btn btn-info text-xs py-1 px-3"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
            </div>
            <div class="bg-green-50 p-4 rounded-lg shadow-inner mb-4 border border-green-200">
                <h3 class="font-semibold text-green-700 text-md">Total Ventas</h3>
                <p id="total-sales" class="text-3xl font-bold text-green-600">$0.00</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg shadow-inner border border-blue-200 flex-grow flex flex-col">
                <h3 class="font-semibold text-blue-700 text-md mb-2">Inventario Actual (Informe)</h3>
                <div id="final-inventory" class="text-sm text-blue-600 max-h-72 min-h-[5rem] overflow-y-auto flex-grow pr-1">
                    <p class="text-slate-500 text-sm italic p-3 text-center">Cargando resumen de inventario...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="addOrderModalBackdrop" class="modal-backdrop">
        <div class="modal-content w-full max-w-lg" role="dialog" aria-modal="true" aria-labelledby="addOrderModalTitle">
            <div class="modal-header flex justify-between items-center">
                 <h3 id="addOrderModalTitle" class="text-2xl font-semibold text-slate-700">Crear Nuevo Pedido</h3>
                 <button onclick="closeAddOrderModal()" class="text-slate-400 hover:text-red-500 text-3xl transition-colors" aria-label="Cerrar modal">
                    <i class="fas fa-times-circle"></i>
                 </button>
            </div>
            <div class="modal-body">
                <input type="text" id="order-title" placeholder="TÃ­tulo del Pedido (ej: Plato Estrella)" class="input-field mb-4 w-full text-sm">
                <input type="number" id="order-price" placeholder="Precio del Pedido" class="input-field mb-4 w-full text-sm" min="0" step="0.01">

                <h4 class="font-semibold mb-2 text-lg text-slate-700">Ingredientes Requeridos</h4>
                <div id="order-ingredients-list" class="mb-4 max-h-48 overflow-y-auto bg-slate-50 p-3 rounded-md border border-slate-200 pr-1">
                     </div>
                <p id="add-order-error" class="text-red-600 text-sm mt-1 mb-3 hidden"></p>
                <button onclick="addIngredientToOrder()" class="btn btn-primary bg-indigo-500 hover:bg-indigo-600 text-xs py-2 px-4 mb-4 w-full sm:w-auto">
                    <i class="fas fa-plus mr-1"></i> AÃ±adir Fila de Ingrediente
                </button>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddOrderModal()" class="btn btn-secondary w-full sm:w-auto px-6">Cancelar</button>
                <button id="submitOrderBtn" onclick="submitNewOrder()" class="btn btn-primary w-full sm:w-auto px-6">
                    <span class="spinner"></span><span class="btn-text"><i class="fas fa-check mr-2"></i> Crear Pedido</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const API_BASE_URL = 'http://localhost:5000/api'; 
        let LOW_STOCK_THRESHOLD = 10; // Default, will be updated from backend

        // --- Local State ---
        let currentInventory = []; 
        let currentProcessingOrders = [];
        let currentCompletedOrders = [];

        // --- Notification System ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            let iconClass = 'fa-solid fa-circle-info';
            if (type === 'success') iconClass = 'fa-solid fa-check-circle';
            else if (type === 'error') iconClass = 'fa-solid fa-circle-exclamation';
            else if (type === 'warning') iconClass = 'fa-solid fa-triangle-exclamation';
            notification.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
            container.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 5000);
        }

        // --- Confirmation Modal Logic ---
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        let currentConfirmAction = null;

        function openConfirmationModal(title, message, onConfirm, actionButtonClass = 'btn-danger') {
            confirmationModalTitle.textContent = title;
            confirmationModalMessage.textContent = message;
            confirmActionBtn.className = `btn ${actionButtonClass} px-4`; // Reset and apply new class
            confirmationModal.classList.add('active');
            currentConfirmAction = onConfirm;
        }

        function closeConfirmationModal() {
            confirmationModal.classList.remove('active');
            currentConfirmAction = null;
        }

        confirmActionBtn.addEventListener('click', () => {
            if (currentConfirmAction) {
                setButtonLoading(confirmActionBtn, true);
                currentConfirmAction().finally(() => { // Ensure button loading state is reset
                    setButtonLoading(confirmActionBtn, false);
                    closeConfirmationModal();
                });
            }
        });
        confirmCancelBtn.addEventListener('click', closeConfirmationModal);
        // Close modal with Escape key for confirmation modal
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape' && confirmationModal.classList.contains('active')) {
                closeConfirmationModal();
            }
        });


        // --- API Helper Function ---
        async function fetchData(url, options = {}) {
             try {
                 const response = await fetch(url, options);
                 if (!response.ok) {
                     let errorData;
                     try { errorData = await response.json(); } 
                     catch (e) { errorData = { error: `Error ${response.status}: ${response.statusText}` }; }
                     throw new Error(errorData.error || errorData.message || `HTTP error! status: ${response.status}`);
                 }
                 if (response.status === 204) { return null; }
                 return await response.json();
             } catch (error) {
                 console.error('Fetch error details:', error);
                 showNotification(`Error de API: ${error.message}`, 'error');
                 throw error;
             }
        }
        
        // --- Button Loading State Helper ---
        function setButtonLoading(buttonElement, isLoading, defaultHtmlContent = null) {
            if (!buttonElement) return;
            const textSpan = buttonElement.querySelector('.btn-text');
            const spinner = buttonElement.querySelector('.spinner');

            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.classList.add('loading');
                if (spinner) spinner.style.display = 'inline-block';
                if (textSpan && !buttonElement.dataset.originalContent) {
                     buttonElement.dataset.originalContent = textSpan.innerHTML;
                     // textSpan.innerHTML = `Procesando...`; // Text can be removed if spinner is prominent
                } else if (!textSpan && !buttonElement.dataset.originalContent) {
                    buttonElement.dataset.originalContent = buttonElement.innerHTML;
                    // buttonElement.innerHTML = `<span class="spinner" style="display:inline-block"></span> Procesando...`;
                }
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('loading');
                if (spinner) spinner.style.display = 'none';
                if (textSpan && buttonElement.dataset.originalContent) {
                    textSpan.innerHTML = buttonElement.dataset.originalContent;
                } else if (!textSpan && buttonElement.dataset.originalContent) {
                     buttonElement.innerHTML = buttonElement.dataset.originalContent;
                } else if (defaultHtmlContent) { // Fallback if original content wasn't stored
                    if(textSpan) textSpan.innerHTML = defaultHtmlContent;
                    else buttonElement.innerHTML = defaultHtmlContent;
                }
                delete buttonElement.dataset.originalContent;
            }
        }

        // --- Rendering Functions ---
        function renderInventory(itemsToRender = null) {
            const listElement = document.getElementById('inventory-list');
            const items = itemsToRender || currentInventory; // Use filtered list if provided

            listElement.innerHTML = ''; 
            if (items.length === 0) {
                const searchTerm = document.getElementById('inventory-search').value;
                listElement.innerHTML = `<p class="text-slate-500 text-sm p-4 text-center">${searchTerm ? 'No hay items que coincidan con su bÃºsqueda.' : 'El inventario estÃ¡ vacÃ­o. Â¡Agrega algunos items!'}</p>`;
                return;
            }
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = `flex justify-between items-center py-2.5 px-3 my-1 border-b border-slate-100 hover:bg-slate-50 rounded-md transition-colors text-sm ${item.quantity < LOW_STOCK_THRESHOLD ? 'low-stock-indicator' : ''}`;
                itemElement.innerHTML = `
                    <span class="text-slate-700 ${item.quantity < LOW_STOCK_THRESHOLD ? 'font-semibold' : ''}">${item.name}</span>
                    <span class="font-semibold ${item.quantity < LOW_STOCK_THRESHOLD ? 'text-red-600 low-stock-text' : 'bg-blue-100 text-blue-700'} px-3 py-1 rounded-full text-xs">${item.quantity} und</span>
                `;
                listElement.appendChild(itemElement);
            });
        }
        
        function filterInventory() {
            const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
            const filteredItems = currentInventory.filter(item => item.name.toLowerCase().includes(searchTerm));
            renderInventory(filteredItems);
        }


        function renderOrders(orderType, ordersToRender = null) { // orderType: 'processing' or 'completed'
            const listId = `${orderType}-orders`;
            const searchInputId = `${orderType}-orders-search`;
            const listElement = document.getElementById(listId);
            
            const orders = ordersToRender !== null ? ordersToRender : (orderType === 'processing' ? currentProcessingOrders : currentCompletedOrders);

            listElement.innerHTML = '';
            if (orders.length === 0) {
                const searchTerm = document.getElementById(searchInputId) ? document.getElementById(searchInputId).value : "";
                const emptyMessage = searchTerm ? `No hay pedidos que coincidan con su bÃºsqueda.` : `No hay pedidos ${orderType === 'processing' ? 'en proceso' : 'completados'}.`;
                listElement.innerHTML = `<p class="text-slate-500 text-sm p-3 text-center">${emptyMessage}</p>`;
                return;
            }
            orders.forEach(order => listElement.appendChild(createOrderCard(order)));
        }

        function filterProcessingOrders() {
            const searchTerm = document.getElementById('processing-orders-search').value.toLowerCase();
            const filteredOrders = currentProcessingOrders.filter(order => order.title.toLowerCase().includes(searchTerm));
            renderOrders('processing', filteredOrders);
        }

        function filterCompletedOrders() {
            const searchTerm = document.getElementById('completed-orders-search').value.toLowerCase();
            const filteredOrders = currentCompletedOrders.filter(order => order.title.toLowerCase().includes(searchTerm));
            renderOrders('completed', filteredOrders);
        }


        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'bg-white p-3.5 rounded-lg shadow-md border border-slate-200 mb-3 text-sm hover:shadow-lg transition-shadow';
            const ingredientsHtml = order.ingredients.map(ing => `<span class="bg-slate-200 text-slate-700 px-2 py-0.5 rounded-full text-xs mr-1 mb-1 inline-block">${ing.name} (x${ing.quantity})</span>`).join(' ');
            
            let buttonsHtml = '';
            if (order.status === 'processing') {
                buttonsHtml = `
                    <div class="mt-3 pt-3 border-t border-slate-100 flex flex-col sm:flex-row gap-2 justify-end">
                        <button id="completeOrderBtn-${order.id}" onclick="confirmCompleteOrder(${order.id}, this)" class="btn btn-success text-xs py-1.5 px-3 w-full sm:w-auto">
                            <span class="spinner"></span><span class="btn-text"><i class="fas fa-check mr-1"></i> Completar</span>
                        </button>
                        <button id="cancelOrderBtn-${order.id}" onclick="confirmCancelOrder(${order.id}, this)" class="btn btn-danger text-xs py-1.5 px-3 w-full sm:w-auto">
                            <span class="spinner"></span><span class="btn-text"><i class="fas fa-times mr-1"></i> Cancelar</span>
                        </button>
                    </div>
                `;
            } else {
                 buttonsHtml = `<div class="text-xs text-green-600 font-semibold mt-2 pt-2 border-t border-slate-100 flex items-center"><i class="fas fa-check-circle mr-2 text-lg"></i>Pedido Completado</div>`;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                     <span class="font-semibold text-slate-800 text-md break-all">${order.title} (#${order.id})</span>
                     <span class="font-bold text-blue-600 text-lg whitespace-nowrap ml-2">$${order.price.toFixed(2)}</span>
                </div>
                <div class="text-xs text-slate-600 mb-2">Ingredientes:</div>
                <div class="flex flex-wrap">${ingredientsHtml || '<span class="text-slate-500 italic">N/A</span>'}</div>
                ${buttonsHtml}
            `;
            return card;
        }

        async function loadInitialData() {
            document.getElementById('inventory-list').innerHTML = '<p class="text-slate-500 text-sm italic p-4 text-center">Actualizando inventario...</p>';
            document.getElementById('processing-orders').innerHTML = '<p class="text-slate-500 text-sm italic p-3 text-center">Actualizando pedidos en proceso...</p>';
            document.getElementById('completed-orders').innerHTML = '<p class="text-slate-500 text-sm italic p-3 text-center">Actualizando historial de pedidos...</p>';
            document.getElementById('final-inventory').innerHTML = '<p class="text-slate-500 text-sm italic p-3 text-center">Actualizando resumen de inventario...</p>';
            document.getElementById('total-sales').textContent = 'Calculando...';
            
            try {
                // Fetch all data concurrently
                const [invData, procOrdersData, compOrdersData, reportData] = await Promise.all([
                    fetchData(`${API_BASE_URL}/inventory`),
                    fetchData(`${API_BASE_URL}/orders?status=processing`),
                    fetchData(`${API_BASE_URL}/orders?status=completed`),
                    fetchData(`${API_BASE_URL}/report`)
                ]);

                currentInventory = invData || [];
                currentProcessingOrders = procOrdersData || [];
                currentCompletedOrders = compOrdersData || [];
                
                if(reportData && typeof reportData.low_stock_threshold !== 'undefined') {
                    LOW_STOCK_THRESHOLD = parseInt(reportData.low_stock_threshold) || 10;
                }

                renderInventory();
                renderOrders('processing');
                renderOrders('completed');
                
                // Render Report
                const totalSalesEl = document.getElementById('total-sales');
                const finalInventoryList = document.getElementById('final-inventory');
                if (reportData) {
                    totalSalesEl.textContent = `$${reportData.total_sales.toFixed(2)}`;
                    finalInventoryList.innerHTML = '';
                    if (reportData.final_inventory.length === 0) {
                        finalInventoryList.innerHTML = '<p class="text-slate-500 text-sm p-3 text-center">Inventario vacÃ­o.</p>';
                    } else {
                        reportData.final_inventory.forEach(item => {
                            const itemElement = document.createElement('div');
                            const isLow = item.quantity < LOW_STOCK_THRESHOLD;
                            itemElement.className = `flex justify-between items-center py-1.5 px-1 text-xs border-b border-blue-100 last:border-b-0 hover:bg-blue-50 rounded-md ${isLow ? 'low-stock-indicator' : ''}`;
                            itemElement.innerHTML = `
                                <span class="${isLow ? 'font-semibold':''}">${item.name}</span>
                                <span class="font-medium ${isLow ? 'text-red-600 low-stock-text':''}">${item.quantity} und</span>
                            `;
                            finalInventoryList.appendChild(itemElement);
                        });
                    }
                } else {
                    totalSalesEl.textContent = '$ Error';
                    finalInventoryList.innerHTML = '<p class="text-red-500 text-sm p-3 text-center">Error al cargar el informe.</p>';
                }

            } catch (error) {
                showNotification('Error fatal al cargar datos iniciales. Intente recargar la pÃ¡gina.', 'error');
                // Set empty states with error messages
                document.getElementById('inventory-list').innerHTML = '<p class="text-red-500 text-sm p-4 text-center">Error al cargar inventario.</p>';
                document.getElementById('processing-orders').innerHTML = '<p class="text-red-500 text-sm p-3 text-center">Error al cargar pedidos.</p>';
                document.getElementById('completed-orders').innerHTML = '<p class="text-red-500 text-sm p-3 text-center">Error al cargar historial.</p>';
                document.getElementById('final-inventory').innerHTML = '<p class="text-red-500 text-sm p-3 text-center">Error al cargar informe.</p>';
            }
        }


        // --- UI Interaction Functions ---
        function showErrorMessage(elementId, message) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) { errorEl.textContent = message; errorEl.classList.remove('hidden'); }
        }
        function hideErrorMessage(elementId) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) { errorEl.classList.add('hidden'); errorEl.textContent = ''; }
        }

        async function addInventoryItem() {
            const nameInput = document.getElementById('ingredient-name');
            const qtyInput = document.getElementById('ingredient-qty');
            const addButton = document.getElementById('addInventoryBtn');
            const name = nameInput.value.trim();
            const quantityStr = qtyInput.value; 
            const errorElId = 'add-inventory-error';
            hideErrorMessage(errorElId);

            if (!name) { showErrorMessage(errorElId, 'El nombre del ingrediente es requerido.'); return; }
            if (!quantityStr) { showErrorMessage(errorElId, 'La cantidad a agregar es requerida.'); return; }
            
            let quantity;
            try {
                quantity = parseInt(quantityStr);
                if (isNaN(quantity) || quantity <= 0) throw new Error();
            } catch {
                showErrorMessage(errorElId, 'La cantidad debe ser un nÃºmero entero positivo.'); return;
            }

            setButtonLoading(addButton, true);
            try {
                const updatedItem = await fetchData(`${API_BASE_URL}/inventory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, quantity }) 
                });
                nameInput.value = ''; qtyInput.value = '';
                showNotification(`"${updatedItem.name}" actualizado/agregado exitosamente.`, 'success');
                await loadInitialData(); // Reload all data to reflect changes everywhere
            } catch (error) {
                 showErrorMessage(errorElId, `${error.message}`);
            } finally {
                setButtonLoading(addButton, false);
            }
        }
        
        const addOrderModalBackdrop = document.getElementById('addOrderModalBackdrop');
        const orderTitleInput = document.getElementById('order-title');

        function openAddOrderModal() {
            orderTitleInput.value = '';
            document.getElementById('order-price').value = '';
            document.getElementById('order-ingredients-list').innerHTML = '';
            hideErrorMessage('add-order-error'); 
            addIngredientToOrder(); 
            addOrderModalBackdrop.classList.add('active');
            setTimeout(() => { orderTitleInput.focus(); }, 50); // Ensure focus after modal animation
        }

        function closeAddOrderModal() {
            addOrderModalBackdrop.classList.remove('active');
        }

        function addIngredientToOrder() {
            const container = document.getElementById('order-ingredients-list');
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'flex gap-2 mb-2 items-center order-ingredient-row p-2 bg-slate-100 rounded';
            
            const optionsHtml = currentInventory.length > 0 
                 ? currentInventory.map(item => `<option value="${item.name}">${item.name} (${item.quantity} disp.)</option>`).join('')
                 : '<option value="" disabled>Cargando inventario...</option>';

            ingredientRow.innerHTML = `
                <select class="input-field w-full flex-grow order-ingredient-name bg-white text-sm">
                    <option value="">Selecciona ingrediente...</option>
                    ${optionsHtml}
                </select>
                <input type="number" placeholder="Cant." class="input-field w-24 order-ingredient-qty text-sm" min="1">
                <button onclick="removeIngredientFromOrder(this)" 
                        class="text-slate-400 hover:text-red-600 text-xl px-2 py-1 rounded transition-colors" 
                        title="Eliminar ingrediente" aria-label="Eliminar fila de ingrediente">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            container.appendChild(ingredientRow);
        }

        function removeIngredientFromOrder(button) {
            button.closest('.order-ingredient-row').remove();
        }

        async function submitNewOrder() {
            const title = document.getElementById('order-title').value.trim();
            const priceStr = document.getElementById('order-price').value;
            const ingredientRows = document.querySelectorAll('.order-ingredient-row');
            const submitButton = document.getElementById('submitOrderBtn');
            const orderIngredients = [];
            const errorElId = 'add-order-error';
            hideErrorMessage(errorElId);

            if (!title) { showErrorMessage(errorElId, 'El tÃ­tulo del pedido es requerido.'); return; }
            if (!priceStr) { showErrorMessage(errorElId, 'El precio del pedido es requerido.'); return; }
            
            let price;
            try {
                 price = parseFloat(priceStr);
                 if (isNaN(price) || price < 0) throw new Error("El precio debe ser un nÃºmero no negativo.");
            } catch(e) {
                 showErrorMessage(errorElId, e.message); return;
            }

            let validIngredients = true;
            ingredientRows.forEach(row => {
                const nameSelect = row.querySelector('.order-ingredient-name');
                const qtyInput = row.querySelector('.order-ingredient-qty');
                const name = nameSelect.value;
                const quantityStr = qtyInput.value;

                if (name && quantityStr) {
                    const quantity = parseInt(quantityStr);
                    if (!isNaN(quantity) && quantity > 0) {
                        orderIngredients.push({ name, quantity });
                    } else { validIngredients = false; }
                } else if (name || quantityStr) { validIngredients = false; }
            });

            if (!validIngredients) { showErrorMessage(errorElId, 'Todos los ingredientes deben tener nombre y cantidad positiva. Elimine filas incompletas.'); return; }
            if (orderIngredients.length === 0) { showErrorMessage(errorElId, 'El pedido debe tener al menos un ingrediente vÃ¡lido.'); return; }

            setButtonLoading(submitButton, true);
            try {
                const newOrder = await fetchData(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, price, ingredients: orderIngredients })
                });
                showNotification(`Pedido #${newOrder.id} "${newOrder.title}" creado exitosamente.`, 'success');
                closeAddOrderModal(); 
                await loadInitialData(); 
            } catch (error) {
                 showErrorMessage(errorElId, `Error: ${error.message}`);
            } finally {
                setButtonLoading(submitButton, false);
            }
        }

        function confirmCompleteOrder(orderId, buttonElement) {
            const order = currentProcessingOrders.find(o => o.id === orderId);
            if (!order) return;
            openConfirmationModal(
                `Completar Pedido #${orderId}`,
                `Â¿EstÃ¡s seguro de completar el pedido "${order.title}"? Esto descontarÃ¡ el inventario.`,
                async () => { // This function is the onConfirm callback
                    // The buttonElement for the modal's confirm button is confirmActionBtn
                    // The buttonElement passed here is the one on the order card
                    const originalCardButton = document.getElementById(`completeOrderBtn-${orderId}`);
                    if (originalCardButton) setButtonLoading(originalCardButton, true); // Set loading on card button

                    try {
                        const completedOrder = await fetchData(`${API_BASE_URL}/orders/${orderId}/complete`, { method: 'PUT' });
                        showNotification(`Pedido #${completedOrder.id} completado.`, 'success');
                        await loadInitialData();
                    } catch (error) {
                        // Error already shown by fetchData, button state handled in finally of confirmActionBtn.click
                        if (originalCardButton) setButtonLoading(originalCardButton, false); // Reset card button on error
                        // Re-throw to ensure modal's finally also runs if needed, though not strictly necessary here
                        throw error; 
                    }
                },
                'btn-success' // Custom class for the confirm button in the modal
            );
        }

        function confirmCancelOrder(orderId, buttonElement) {
            const order = currentProcessingOrders.find(o => o.id === orderId);
            if (!order) return;
            openConfirmationModal(
                `Cancelar Pedido #${orderId}`,
                `Â¿EstÃ¡s seguro de cancelar el pedido "${order.title}"? Esta acciÃ³n no se puede deshacer.`,
                async () => {
                    const originalCardButton = document.getElementById(`cancelOrderBtn-${orderId}`);
                    if (originalCardButton) setButtonLoading(originalCardButton, true);
                    try {
                        await fetchData(`${API_BASE_URL}/orders/${orderId}`, { method: 'DELETE' });
                        showNotification(`Pedido #${orderId} cancelado.`, 'info');
                        await loadInitialData();
                    } catch (error) {
                        if (originalCardButton) setButtonLoading(originalCardButton, false);
                        throw error;
                    }
                },
                'btn-danger'
            );
        }

        // --- PDF Generation Functions ---
        async function downloadReportPDF(event) {
            const button = event.currentTarget;
            setButtonLoading(button, true);
            try {
                const reportData = await fetchData(`${API_BASE_URL}/report`);
                if (!reportData) { showNotification("No se pudieron obtener los datos del informe.", "warning"); return; }
                const { jsPDF } = window.jspdf; 
                const doc = new jsPDF();
                doc.setFontSize(18); doc.setTextColor(44, 62, 80); // Darker Slate
                doc.text("Informe Financiero y de Inventario", 105, 22, null, null, "center");
                doc.setFontSize(10); doc.setTextColor(100, 116, 139); // Slate 500
                doc.text(`Generado el: ${new Date().toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'short'})}`, 105, 30, null, null, "center");

                doc.setFontSize(14); doc.setTextColor(44, 62, 80);
                doc.text("Resumen de Ventas", 14, 48);
                doc.setFontSize(12); doc.setTextColor(22, 163, 74); // Green 600
                doc.text(`Total Ventas: $${reportData.total_sales.toFixed(2)}`, 14, 56);

                doc.setFontSize(14); doc.setTextColor(44, 62, 80);
                doc.text(`Inventario Final (Umbral Bajo Stock: ${LOW_STOCK_THRESHOLD})`, 14, 72);

                if (reportData.final_inventory && reportData.final_inventory.length > 0) {
                    const tableColumn = ["ID", "Nombre", "Cantidad"];
                    const tableRows = [];
                    reportData.final_inventory.forEach(item => {
                        const isLow = item.quantity < LOW_STOCK_THRESHOLD;
                        tableRows.push([item.id, `${item.name}${isLow ? ' (Bajo!)' : ''}`, item.quantity]);
                    });
                    doc.autoTable({
                        head: [tableColumn], body: tableRows, startY: 78, theme: 'striped',
                        headStyles: { fillColor: [71, 85, 105] }, // Slate 600
                        styles: { font: 'helvetica', fontSize: 10 },
                        didParseCell: function (data) { // Highlight low stock rows
                            const item = reportData.final_inventory[data.row.index];
                            if (item && item.quantity < LOW_STOCK_THRESHOLD) {
                                if (data.column.index === 1 || data.column.index === 2) { // Name and Quantity columns
                                    data.cell.styles.textColor = [220, 38, 38]; // Red 600
                                    data.cell.styles.fontStyle = 'bold';
                                }
                            }
                        }
                    });
                } else {
                    doc.setFontSize(10); doc.setTextColor(100,116,139);
                    doc.text("El inventario estÃ¡ vacÃ­o.", 14, 86);
                }
                
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i); doc.setFontSize(8); doc.setTextColor(148, 163, 184); // Slate 400
                    doc.text(`PÃ¡gina ${i} de ${pageCount}`, 105, doc.internal.pageSize.getHeight() - 10, null, null, "center");
                }
                doc.save('informe_inventario_ventas.pdf');
                showNotification("Informe PDF generado.", "success");
            } catch (error) {
                showNotification("Error al generar PDF del informe.", "error");
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function downloadInventoryPDF(event) {
            const button = event.currentTarget;
            setButtonLoading(button, true);
            if (!currentInventory || currentInventory.length === 0) {
                showNotification("El inventario estÃ¡ vacÃ­o.", "warning");
                setButtonLoading(button, false); return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.setTextColor(44, 62, 80);
                doc.text(`Lista de Inventario (Umbral Bajo: ${LOW_STOCK_THRESHOLD})`, 105, 22, null, null, "center");
                 doc.setFontSize(10); doc.setTextColor(100, 116, 139);
                doc.text(`Generado el: ${new Date().toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'short'})}`, 105, 30, null, null, "center");

                const tableColumn = ["ID", "Nombre del Ingrediente", "Cantidad Actual"];
                const tableRows = [];
                currentInventory.forEach(item => {
                    const isLow = item.quantity < LOW_STOCK_THRESHOLD;
                    tableRows.push([item.id, `${item.name}${isLow ? ' (Bajo!)' : ''}`, item.quantity]);
                });
                doc.autoTable({
                    head: [tableColumn], body: tableRows, startY: 38, theme: 'grid',
                    headStyles: { fillColor: [59, 130, 246] }, styles: { font: 'helvetica', fontSize: 10 }, // Blue 500
                     didParseCell: function (data) {
                        const item = currentInventory[data.row.index];
                        if (item && item.quantity < LOW_STOCK_THRESHOLD) {
                             if (data.column.index === 1 || data.column.index === 2) {
                                data.cell.styles.textColor = [220, 38, 38];
                                data.cell.styles.fontStyle = 'bold';
                            }
                        }
                    }
                });
                // ... (pagination as before)
                doc.save('lista_inventario_actual.pdf');
                showNotification("PDF de inventario generado.", "success");
            } catch (error) {
                showNotification("Error al generar PDF de inventario.", "error");
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function downloadOrdersPDF(status, event) {
            const button = event.currentTarget;
            setButtonLoading(button, true);
            let ordersData;
            let titleReport;
            let fileName;
            let headerColor;

            try {
                ordersData = (status === 'processing') ? currentProcessingOrders : currentCompletedOrders;
                 if (!ordersData || ordersData.length === 0) {
                    showNotification(`No hay pedidos con estado '${status}' para generar el PDF.`, "warning");
                    setButtonLoading(button, false); return;
                }

                if (status === 'completed') {
                    titleReport = "HistÃ³rico de Pedidos Completados"; fileName = "pedidos_completados.pdf"; headerColor = [100, 116, 139]; // Slate 500
                } else if (status === 'processing') {
                    titleReport = "Pedidos en Proceso"; fileName = "pedidos_en_proceso.pdf"; headerColor = [245, 158, 11]; // Amber 500
                } else {
                    showNotification("Estado de pedido no vÃ¡lido para PDF.", "error"); setButtonLoading(button, false); return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape'); 
                // ... (PDF generation code as before, using titleReport)
                doc.save(fileName);
                showNotification(`PDF de pedidos (${status}) generado.`, "success");
            } catch (error) {
                 showNotification(`Error al generar PDF de pedidos (${status}).`, "error");
            } finally {
                setButtonLoading(button, false);
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', loadInitialData);

        // Close Add Order modal with Escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape' && addOrderModalBackdrop.classList.contains('active')) {
                closeAddOrderModal();
            }
        });
    </script>

</body>
</html>